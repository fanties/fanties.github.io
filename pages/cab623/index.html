<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>幂等性 | 知微坚果的拾光小镇</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" href="http://picqq.oss-cn-shenzhen.aliyuncs.com//pic/md/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <meta name="description" content="道虽迩，不行不至，事虽小，不为不成。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="知微坚果,一念千秋,拾光小镇,Go,Golang开发,Java,Flutter,Kotlin,后端,架构">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.2c4acd8f.css" as="style"><link rel="preload" href="/assets/js/app.aefa215f.js" as="script"><link rel="preload" href="/assets/js/2.a2e47d19.js" as="script"><link rel="preload" href="/assets/js/15.7c4325b5.js" as="script"><link rel="preload" href="/assets/js/4.8618805e.js" as="script"><link rel="preload" href="/assets/js/8.0c0b2ac3.js" as="script"><link rel="preload" href="/assets/js/13.94a18eaf.js" as="script"><link rel="prefetch" href="/assets/js/10.9471f815.js"><link rel="prefetch" href="/assets/js/11.c8378516.js"><link rel="prefetch" href="/assets/js/12.6ac8a5f0.js"><link rel="prefetch" href="/assets/js/14.847033a3.js"><link rel="prefetch" href="/assets/js/16.e96e5ab3.js"><link rel="prefetch" href="/assets/js/17.7546f5a3.js"><link rel="prefetch" href="/assets/js/18.be0fb2b2.js"><link rel="prefetch" href="/assets/js/19.9ef95fcf.js"><link rel="prefetch" href="/assets/js/20.5b6f55f6.js"><link rel="prefetch" href="/assets/js/21.c02217b3.js"><link rel="prefetch" href="/assets/js/22.9a7efe2f.js"><link rel="prefetch" href="/assets/js/23.e8703be7.js"><link rel="prefetch" href="/assets/js/24.bcb275f2.js"><link rel="prefetch" href="/assets/js/25.ef52f3f4.js"><link rel="prefetch" href="/assets/js/26.fc33ad9c.js"><link rel="prefetch" href="/assets/js/27.247160fc.js"><link rel="prefetch" href="/assets/js/28.85f03759.js"><link rel="prefetch" href="/assets/js/29.70302fd1.js"><link rel="prefetch" href="/assets/js/3.9db64edd.js"><link rel="prefetch" href="/assets/js/30.7df491ac.js"><link rel="prefetch" href="/assets/js/31.9e12a9ab.js"><link rel="prefetch" href="/assets/js/32.95df1632.js"><link rel="prefetch" href="/assets/js/33.ebb35b81.js"><link rel="prefetch" href="/assets/js/34.839bb7ff.js"><link rel="prefetch" href="/assets/js/35.40eacfdf.js"><link rel="prefetch" href="/assets/js/36.eddcdeb2.js"><link rel="prefetch" href="/assets/js/37.6e1a687e.js"><link rel="prefetch" href="/assets/js/38.4f3c4286.js"><link rel="prefetch" href="/assets/js/39.03cf763c.js"><link rel="prefetch" href="/assets/js/40.1393825d.js"><link rel="prefetch" href="/assets/js/41.c965769a.js"><link rel="prefetch" href="/assets/js/42.6085d2d8.js"><link rel="prefetch" href="/assets/js/43.89210b28.js"><link rel="prefetch" href="/assets/js/44.c4f41cdb.js"><link rel="prefetch" href="/assets/js/45.47666a6a.js"><link rel="prefetch" href="/assets/js/46.16904a76.js"><link rel="prefetch" href="/assets/js/47.63a8e7d9.js"><link rel="prefetch" href="/assets/js/48.74f5fefe.js"><link rel="prefetch" href="/assets/js/49.ee37b28a.js"><link rel="prefetch" href="/assets/js/5.04b89f6c.js"><link rel="prefetch" href="/assets/js/50.82710bea.js"><link rel="prefetch" href="/assets/js/51.04b5f741.js"><link rel="prefetch" href="/assets/js/52.1297b7bc.js"><link rel="prefetch" href="/assets/js/6.92e03c58.js"><link rel="prefetch" href="/assets/js/7.f7306d6f.js"><link rel="prefetch" href="/assets/js/9.3a6ab990.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2c4acd8f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="http://picqq.oss-cn-shenzhen.aliyuncs.com//pic/md/8.svg" alt="知微坚果的拾光小镇" class="logo"> <span class="site-name can-hide">知微坚果的拾光小镇</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/speak/" class="nav-link">随笔</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><a href="/language/" class="link-title">语言</a> <span class="title" style="display:none;">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Golang</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/go/basic/" class="nav-link">基础</a></li><li class="dropdown-subitem"><a href="/go/lib/" class="nav-link">第三方库</a></li></ul></li><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/front/flutter/" class="nav-link">Flutter</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tools/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/" class="nav-link">开发工具</a></li><li class="dropdown-item"><!----> <a href="/sys/" class="nav-link">系统工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><a href="/projects/" class="link-title">项目</a> <span class="title" style="display:none;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/inooy/timer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Timer
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">时间线</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div> <a href="https://github.com/fanties" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://fanties.oss-cn-shenzhen.aliyuncs.com/avatar.jpeg"> <div class="blogger-info"><h3>知微坚果</h3> <span>行者常至，为者常成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/speak/" class="nav-link">随笔</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><a href="/language/" class="link-title">语言</a> <span class="title" style="display:none;">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Golang</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/go/basic/" class="nav-link">基础</a></li><li class="dropdown-subitem"><a href="/go/lib/" class="nav-link">第三方库</a></li></ul></li><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/front/flutter/" class="nav-link">Flutter</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tools/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/" class="nav-link">开发工具</a></li><li class="dropdown-item"><!----> <a href="/sys/" class="nav-link">系统工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><a href="/projects/" class="link-title">项目</a> <span class="title" style="display:none;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/inooy/timer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Timer
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">时间线</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div> <a href="https://github.com/fanties" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>幂等性</span> <!----></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E5%90%8E%E7%AB%AF" title="分类" data-v-06225672>后端</a></li><li data-v-06225672><a href="/categories/?category=%E7%90%86%E8%AE%BA" title="分类" data-v-06225672>理论</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://flyoo.cn/" target="_blank" title="作者" class="beLink" data-v-06225672>知微坚果</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2020-12-05</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">幂等性<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h3 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h3> <p>幂等性原本是数学上的概念，即使公式：f(x)=f(f(x)) 能够成立的数学性质。用在编程领域，则意为对同一个系统，使用同样的条件，一次请求和重复的多次请求对系统资源的影响是一致的。</p> <p>幂等性是分布式系统设计中十分重要的概念，具有这一性质的接口在设计时总是秉持这样的一种理念：调用接口发生异常并且重复尝试时，总是会造成系统所无法承受的损失，所以必须阻止这种现象的发生。</p> <p>幂等有两个维度：一是空间维度上的幂等，即幂等对象的范围，是个人还是机构，是某一次交易还是某种类型的交易...二是时间维度上的幂等，即幂等的保证时间，是几秒、几分钟还是永久性的...</p> <p>不同的需求，会有不一样的解决方案，难度和成本也不一样。</p> <p>HTTP/1.1中对幂等性的定义是:</p> <blockquote><p>Methods can also have the property of &quot;idempotence&quot; in that (aside from error or expiration issues) the side-effects of N &gt; 0 identical requests is the same as for a single.          《rfc2616 - 9.1.2 Idempotent Methods》</p></blockquote> <p>一次和多次请求某一个资源对于资源本身应该具有同样的结果（网络超时等问题除外）。也就是说，其任意多次执行对资源本身所产生的影响均与一次执行的影响相同。</p> <ol><li>幂等不仅仅只是一次（或多次）请求对资源没有副作用（比如查询数据库操作，没有增删改，因此没有对数据库有任何影响）。</li> <li>幂等还包括第一次请求的时候对资源产生了副作用，但是以后的多次请求都不会再对资源产生副作用。</li> <li>幂等关注的是以后的多次请求是否对资源产生的副作用，而不关注结果。</li> <li>网络超时等问题，不是幂等的讨论范围。</li></ol> <p>幂等性是系统服务对外一种承诺（而不是实现），承诺只要调用接口成功，外部多次调用对系统的影响是一致的。声明为幂等的服务会认为外部调用失败是常态，并且失败之后必然会有重试。</p> <h3 id="不满足幂等性的情况"><a href="#不满足幂等性的情况" class="header-anchor">#</a> 不满足幂等性的情况</h3> <p>产生重复数据或数据不一致（假定程序业务代码没问题），绝大部分就是发生了重复的请求，重复请求是指同一个请求因为某些原因被多次提交。导致这个情况会有几种场景：</p> <ol><li>网络波动, 可能会引起重复请求</li> <li>用户重复操作,用户在操作时候可能会无意触发多次下单交易,甚至没有响应而有意触发多次交易应用</li> <li>使用了失效或超时重试机制(Nginx重试、RPC重试或业务层重试等)</li> <li>页面重复刷新</li> <li>使用浏览器后退按钮重复之前的操作,导致重复提交表单</li> <li>使用浏览器历史记录重复提交表单</li> <li>浏览器重复的HTTP请求</li> <li>定时任务重复执行</li> <li>用户双击提交按钮</li> <li>MQ消息中间件，消息重复消费</li> <li>第三方平台的接口（如：支付成功回调接口、微信公众号消息接口），因为异常也会导致多次异步回调</li> <li>其他中间件/应用服务根据自身的特性，也有可能进行重试。</li></ol> <h3 id="请求幂等性的解决方案"><a href="#请求幂等性的解决方案" class="header-anchor">#</a> 请求幂等性的解决方案</h3> <p>为了保证幂等性，我们可以从两个方面入手</p> <ol><li>客户端防止重复请求</li> <li>服务端进行校验</li></ol> <p>客户端防止重复请求一般只是一种简单有效的优化方式，这并不能保证可靠性</p> <h4 id="客户端处理"><a href="#客户端处理" class="header-anchor">#</a> 客户端处理</h4> <p>客户端处理一般有：</p> <ol><li>函数节流</li> <li>函数防抖</li> <li>点击后按钮设置为不可点击</li> <li>拦截多次点击，客户端直接响应</li> <li>阻塞操作界面，比如Loading状态</li></ol> <h4 id="token机制"><a href="#token机制" class="header-anchor">#</a> token机制</h4> <p>为每一次操作都生成一个单独的唯一token（以下简称token）。一个token在操作的每一个阶段只有一次执行权，一旦执行成功则保存执行结果。对重复的请求，返回同一个结果。</p> <p>在订单提交的场景，订单ID就可以作为一个token。每一个环节执行时都先检测一下该订单ID是否已经执行过这一步骤，对未执行的请求，执行操作并缓存结果，而对已经执行过的ID，则直接返回之前的执行结果，不做任何操作。</p> <p>在写操作之前，还可以用这个token进行上锁，保证同一个token只进行一次写操作。</p> <p>开源轮子可以参考：redis-auto-idempotent-spring-boot-starter</p> <h4 id="全局唯一id"><a href="#全局唯一id" class="header-anchor">#</a> 全局唯一ID</h4> <p>和token原理一样，主要是实现细节稍微不同
比如通过source来源 + 唯一序列号传入给后端，后端来判断请求是否重复,在并发时只能处理一个请求,其他相同并发请求要么返回请求重复,要么等待 前面请求执行完成后再执行。</p> <h4 id="使用post-redirect-get-rpg-模式"><a href="#使用post-redirect-get-rpg-模式" class="header-anchor">#</a> 使用Post/Redirect/Get(RPG)模式</h4> <p>在提交后执行页面重定向,这就是所谓的Post-Redirect—Get(PRG)模式,简单来说就是当用户提交连表单后,跳转到一个重定向的信息页面,这样就避免用户按F5刷新导致的重复提交,而且也不会出现浏览器表单重复提交的警告,也能消除按浏览器前进和后退导致同样重复提交的问题。</p> <h4 id="在session存放特殊标志"><a href="#在session存放特殊标志" class="header-anchor">#</a> 在session存放特殊标志</h4> <p>在服务端,生成一个唯一的标识符,将它存入session,同时前端获取这个标识符的值将它写入表单的隐藏中,用于用户输入信息后点击一起提交,在服务器端,获取表单中隐藏字段的值,与session中的唯一标识符比较,相等说明是首次提交,就处理本次请求,然后将session中的唯一标识符移除,不相等则表示是重复提交,不再做处理。</p> <h4 id="乐观锁"><a href="#乐观锁" class="header-anchor">#</a> 乐观锁</h4> <p>可以乐观锁的思想，利用版本号去做幂等，这个比较适用于更新操作。
每条数据都有一个版本号，数据更新的时候，传入获取到的版本号，且版本号+1。在实际进行写操作的时候，会去比较请求参数里面的版本号，每个version只有一次执行成功的机会，一旦失败必须重新获取。</p> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> age <span class="token operator">=</span> age <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> version <span class="token operator">=</span> version <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token comment">#{id} and version = #{version};</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h4> <p>如果是分布是系统，构建全局唯一索引比较困难，例如唯一性的字段没法确定，这时候可以引入分布式锁，通过第三方的系统(redis或zookeeper)，在业务系统插入数据或者更新数据，获取分布式锁，然后做操作，之后释放锁，这样其实是把多线程并发的锁的思路，引入多多个系统，也就是分布式系统中得解决思路。</p> <p>要点：某个长流程处理过程要求不能并发执行，可以在流程执行之前根据某个标志(用户ID+后缀等)获取分布式锁，其他流程执行时获取锁就会失败，也就是同一时间该流程只能有一个能执行成功，执行完成后，释放分布式锁(分布式锁要第三方系统提供)。</p> <h4 id="状态机幂等"><a href="#状态机幂等" class="header-anchor">#</a> 状态机幂等</h4> <p>在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机(状态变更图)，就是业务单据上面有个状态，状态在不同的情况下会发生变更，一般情况下存在有限状态机，这时候，如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。注意：订单等单据类业务，存在很长的状态流转，一定要深刻理解状态机，对业务系统设计能力提高有很大帮助 。</p> <h4 id="防重表"><a href="#防重表" class="header-anchor">#</a> 防重表</h4> <p>以支付为例: 使用唯一主键去做防重表的唯一索引,比如使用订单号作为防重表的唯一索引,每一次请求都根据订单号向防重表中插入一条数据,插入成功说明可以处理后面的业务,当处理完业务逻辑之后删除防重表中的订单号数据,后续如果有重复请求,则会因为防重表唯一索引原因导致插入失败,直接返回操作失败,直到第一次请求返回结果,可以看出防重表作用就是加锁的功能。
注: 最好结合状态机幂等先判断一下</p> <h4 id="缓冲队列"><a href="#缓冲队列" class="header-anchor">#</a> 缓冲队列</h4> <p>将请求都快速地接收下来后放入缓冲队列中,后续使用异步任务处理队列中的数据,过滤掉重复的请求,该解决方案优点是同步处理改成异步处理、高吞吐量,缺点则是不能及时地返回请求结果,需要后续轮询得处理结果。</p> <h3 id="任务幂等性"><a href="#任务幂等性" class="header-anchor">#</a> 任务幂等性</h3> <p>任务幂等，指的是对于同一段数据，触发一次任务和多次任务是相同的结果。
任务基本上都会涉及到写操作。如果同一段数据，被多次任务触发，进行了多次写操作，可能会造成脏数据。
其实也很好解决，我们在抽象任务模型的时候，给「任务设计好不同的状态」就行了。比如任务初始化、启动后、成功、失败、取消等都有不同的状态。后续的任务触发请求，如果监测到这段数据的状态已经做了修改，就根据这个任务的状态和用户定义
的策略，来决定是跳过还是重新执行。
可以参考Spring Batch的设计，Spring Batch抽象了Job这个概念，提供了BatchStatus枚举来作为任务的状态：
public enum BatchStatus {STARTING, STARTED, STOPPING,    STOPPED, FAILED, COMPLETED, ABANDONED }复制代码
相应的，比Job粒度更小的Step也有自己的状态。同时Spring Batch可以允许用户自定义地配置skip策略和失败处理策略。</p> <h3 id="消息幂等性"><a href="#消息幂等性" class="header-anchor">#</a> 消息幂等性</h3> <p>消息幂等也是经常要考虑的问题。还是之前电商系统中订单提交的例子，比如库存扣减这种操作，为了保证吞吐量，可能会使用消息来实现。
消息幂等的概念可以总结如下：</p> <blockquote><p>如果消息重试多次，消费者端对该重复消息消费多次与消费一次的结果是相同的，并且多次消费没有对系统产生副作用，那么我们就称这个过程是消息幂等的。</p></blockquote> <p>对于消息来说，发送端可能产生重复消息，消费端也可能会重复消费同一条消息（大多数都是因为网络问题）。如果靠消息中间件去实现幂等，是一件比较困难的事情，增加幂等的处理会导致消息中间件的「吞吐量」下降。所以绝大多数消息「消息中间件本身不处理幂等问题」，而是交给了业务端自己去处理。
而不论是发送端重复还是消费端重复，我们「只需要保证消费端幂等」就可以了，不需要在发送端做什么事情。而消费端做幂等，其实本质上也是上面提到的“「重复提交下的幂等」”，比较适合在消费端的入口处就做幂等处理。</p> <h3 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h3> <p><a href="https://www.jianshu.com/p/475589f5cd7b" target="_blank" rel="noopener noreferrer">GameKing.幂等性浅谈.简书.2017.01.07<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://zhuanlan.zhihu.com/p/70748661" target="_blank" rel="noopener noreferrer">Xxxx.幂等性.知乎.2019.06.25<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6897791146194386952" target="_blank" rel="noopener noreferrer">Yasin.幂等问题.掘金.2020.11.22<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6900188956525068301" target="_blank" rel="noopener noreferrer">三分恶.什么是接口幂等性？为什么会产生接口幂等性问题？如何保证接口幂等性？.掘金.2020.11.28<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E7%90%86%E8%AE%BA" title="标签">#理论</a></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">12/2/2022, 12:38:29 AM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/10dcf7/"><div>
            SpringBoot3.0快速上手
            <!----></div></a> <span class="date">12-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/13de43/"><div>
            Spring事务管理源码分析
            <!----></div></a> <span class="date">12-06</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/99581a/"><div>
            Golang工程结构最佳实践
            <!----></div></a> <span class="date">12-04</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1244404139@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/fanties" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=503418750" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>知微坚果 | 拾光小镇<br> <a href="http://beian.miit.gov.cn/" target="_blank">蜀ICP备17001150号-2</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><div></div><div></div><canvas id="vuepress-canvas-cursor"></canvas><div></div><!----><div></div></div></div>
    <script src="/assets/js/app.aefa215f.js" defer></script><script src="/assets/js/2.a2e47d19.js" defer></script><script src="/assets/js/15.7c4325b5.js" defer></script><script src="/assets/js/4.8618805e.js" defer></script><script src="/assets/js/8.0c0b2ac3.js" defer></script><script src="/assets/js/13.94a18eaf.js" defer></script>
  </body>
</html>
