(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{393:function(s,a,t){"use strict";t.r(a);var n=t(0),r=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("我们在Java容器中，经常需要用到jmap等命令，但是默认Java启动的进程号是1，无法使用这些命令。")]),s._v(" "),a("h3",{attrs:{id:"解决spring-boot应用以docker容器方式启动后-进程id是1而导致的jstack和jmap等命令不可用的现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决spring-boot应用以docker容器方式启动后-进程id是1而导致的jstack和jmap等命令不可用的现象"}},[s._v("#")]),s._v(" 解决spring boot应用以docker容器方式启动后，进程ID是1而导致的jstack和jmap等命令不可用的现象")]),s._v(" "),a("p",[s._v("默认将spring boot工程打包成镜像的方式")]),s._v(" "),a("ol",[a("li",[s._v("当我们把spring boot打包成一个可执行jar")]),s._v(" "),a("li",[s._v("编写Dockerfile 将jarcopy到容器中，在cmd 中执行java -jar ***.jar 启动，Dockerfile文件如下")])]),s._v(" "),a("div",{staticClass:"language-Dockerfile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#基础镜像基于openjdk，利用alpine  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" openjdk:8u212-jdk-alpine  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#所属团队  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MAINTAINER")]),s._v(" chengf  ")]),s._v("\n  \n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" JAVA_OPTS="),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-server -Xms512m -Xmx512m"')]),s._v(" LOGGING_LEVEL="),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"INFO"')]),s._v("  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#编译时变量无法在运行时用，此处做一次转换  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" TARGET_JAR="),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spring-boot-sample-0.0.1-SNAPSHOT.jar"')]),s._v("  ")]),s._v("\n  \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将编译好的工程jar包copy到镜像容器中  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TARGET_JAR}")]),s._v(" /usr/src/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TARGET_JAR}")]),s._v("  ")]),s._v("\n  \n  \n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" OPTS="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${JAVA_OPTS}")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" -Dfile.encoding=UTF8    -Duser.timezone=GMT+08"')]),s._v("  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /usr/src  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#程序入口  ")]),s._v("\n  \n  \n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" java -jar "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${OPTS}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TARGET_JAR}")]),s._v(" --logging.level.root="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${LOGGING_LEVEL}")]),s._v("  ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("启动镜像后执行docker exec 进入到容器内部，执行ps可以看到容器中进程号是1的就是我们的应用启动进程")]),s._v(" "),a("h3",{attrs:{id:"解决办法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决办法"}},[s._v("#")]),s._v(" 解决办法")]),s._v(" "),a("p",[s._v("解决办法\n因为jstack jmap等jdk自带的tools放发无法对1号进程分析，那我们就想办法把java进程变为非1号进程对应的Dockerfile")]),s._v(" "),a("div",{staticClass:"language-Dockerfile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#基础镜像基于openjdk，利用alpine  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" openjdk:8u212-jdk-alpine  ")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" JAVA_OPTS="),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-server -Xms512m -Xmx512m"')]),s._v(" LOGGING_LEVEL="),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"INFO"')]),s._v("  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#编译时变量无法在运行时用，此处做一次转换")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" TARGET_JAR="),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spring-boot-sample-0.0.1-SNAPSHOT.jar"')])]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将编译好的工程jar包copy到镜像容器中  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TARGET_JAR}")]),s._v(" /usr/src/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TARGET_JAR}")]),s._v("  ")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" OPTS="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${JAVA_OPTS}")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" -Dfile.encoding=UTF8    -Duser.timezone=GMT+08"')])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /usr/src  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#程序入口  ")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#CMD java -jar ${OPTS} ${TARGET_JAR} --logging.level.root=${LOGGING_LEVEL}  ")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" echo "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"java -jar \\${OPTS} \\${TARGET_JAR} --logging.level.root=\\${LOGGING_LEVEL}"')]),s._v(" > start.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n             && chmod 777 start.sh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# CMD ./start.sh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENTRYPOINT")]),s._v(" ["),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./start.sh"')]),s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("这样启动后1号进程就变成了 start.sh 由1号进程启动的进程才是我们的java进程")]),s._v(" "),a("h3",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("不管通过什么方式 只要让启动命令不是第一个执行的就能解决问题。")]),s._v(" "),a("h3",{attrs:{id:"相关问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#相关问题"}},[s._v("#")]),s._v(" 相关问题")]),s._v(" "),a("p",[s._v("https://github.com/alibaba/arthas/issues/362\nhttps://github.com/docker-library/openjdk/issues/76\nhttps://github.com/krallin/tini")]),s._v(" "),a("h3",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("p",[s._v("解决spring boot应用以docker容器方式启动后，进程ID是1而导致的jstack和jmap等命令不可用的问题\nhttps://www.iteye.com/blog/fengyilin-2451011")])])}),[],!1,null,null,null);a.default=r.exports}}]);